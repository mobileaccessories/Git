<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Update Delivery</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<style>
:root {
  --bg:#f2f3f7;
  --card:#ffffff;
  --text:#1c1c1c;
  --muted:#7a7a7a;
  --border:#e0e3eb;
  --radius:14px;
  --shadow:0 10px 30px rgba(0,0,0,0.05);
  --accent:#111;
  --danger:#d32f2f;
  --font:'Inter',system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  --max:720px;
  --page-vertical-gutter:28px;
}

/* reset / base */
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:var(--bg);
  color:var(--text);
  font-family:var(--font);
  line-height:1.5;
  padding:calc(var(--page-vertical-gutter) + env(safe-area-inset-top, 0px)) 16px calc(var(--page-vertical-gutter) + env(safe-area-inset-bottom, 0px));
  -webkit-font-smoothing:antialiased;
}

/* container */
.container{max-width:var(--max);margin:0 auto}
h1{font-size:1.6rem;font-weight:600;margin-bottom:4px}
.sub{color:var(--muted);margin-bottom:16px;font-size:0.94rem}

/* toolbar */
.toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
.toolbar input{border-radius:12px;border:1px solid var(--border);padding:10px 14px;font-size:0.95rem;flex:1;outline:none;transition:0.2s}
.toolbar input:focus{border-color:var(--accent);box-shadow:0 2px 6px rgba(0,0,0,0.08)}
button{border:none;border-radius:12px;padding:10px 16px;font-size:0.95rem;cursor:pointer;transition:0.2s;min-width:90px}
button:hover{opacity:0.95}
button.ghost{background:#fff;color:var(--text);border:1px solid var(--border)}
button:disabled{opacity:0.5;cursor:not-allowed}

/* card */
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:20px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  margin-bottom:20px;
}
.field{margin-bottom:16px}
label{display:block;font-size:0.9rem;color:var(--muted);margin-bottom:6px}
input, select, textarea{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;background:#fdfdfd;font-size:0.95rem;outline:none;transition:0.2s}
input:focus, select:focus, textarea:focus{border-color:var(--accent);box-shadow:0 2px 6px rgba(0,0,0,0.08)}
textarea{resize:vertical;min-height:60px}

/* rows / columns */
.row{display:flex;gap:12px}
.col{flex:1}

/* buttons row */
.actions{display:flex;gap:12px;justify-content:flex-end;margin-top:12px}
.small-spinner{border:3px solid rgba(0,0,0,0.12);border-top-color:#111;border-radius:50%;width:14px;height:14px;animation:spin .8s linear infinite;display:inline-block;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}

/* messages */
.message{min-height:36px;margin-bottom:12px}
.note{font-size:0.85rem;color:var(--muted);margin-top:8px}

/* table */
table{width:100%;border-collapse:collapse;margin-top:12px;font-size:0.92rem}
th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #f1f3f6}
th{color:var(--muted);font-weight:600}

/* modal */
.modal-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,0.35);
  display:none; align-items:center; justify-content:center; padding:16px; z-index:50;
}
.modal{
  width:100%; max-width:var(--max);
  background:var(--card); border-radius:var(--radius); padding:20px;
  border:1px solid var(--border); box-shadow:0 20px 60px rgba(0,0,0,0.08);
  max-height:calc(100vh - 80px); overflow:auto;
}
.modal h2{margin-bottom:16px;font-size:1.25rem;font-weight:600}

/* scanner */
.scanner-modal .video-wrap{position:relative;border-radius:var(--radius);overflow:hidden;background:#000}
.scanner-modal video{width:100%;height:auto;display:block}
.scan-overlay{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center}
.scan-reticle{width:60%;max-width:400px;height:60%;border:2px dashed rgba(255,255,255,0.18);border-radius:12px}

/* responsive */
@media(max-width:720px){.row{flex-direction:column}}
@media(max-height:700px){.modal-backdrop{align-items:flex-start;padding-top:32px;padding-bottom:32px}}
</style>
</head>
<body>
<div class="container">
  <h1>Update Delivery</h1>
  <div class="sub">Search an order, update status, or create a new order.</div>

  <div class="toolbar">
    <button class="small ghost" onclick="testConnection()">Test Connection</button>
    <button class="small ghost" onclick="openCreateModal()">Create Order</button>
    <input id="quickSearch" placeholder="Search order number..." onkeydown="if(event.key==='Enter'){triggerFetch(this.value)}">
    <button onclick="triggerFetch(document.getElementById('quickSearch').value)">Load</button>
  </div>

  <div id="message" class="message"></div>

  <div class="card" id="mainCard">
    <div id="currentStatusDisplay" style="font-weight:600;margin-bottom:12px">Enter order number to load.</div>

    <div class="field">
      <label for="orderNumber">Order Number</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="orderNumber" placeholder="e.g., K5WCNMKRJXXZ" onkeydown="if(event.key==='Enter'){triggerFetch(this.value)}">
        <button class="ghost small" id="scanBtn" onclick="openScannerModal()" title="Scan QR code">Scan QR</button>
      </div>
      <div class="muted">Type order number, use quick search, or scan QR.</div>
    </div>

    <div class="row">
      <div class="col field">
        <label for="status">Status</label>
        <select id="status" disabled><option>Load order first</option></select>
      </div>
      <div class="col field">
        <label for="location">Location</label>
        <input id="location" placeholder="e.g., Colombo" disabled>
      </div>
    </div>

    <div class="row">
      <div class="col field">
        <label for="deliveryPerson">Delivery Person</label>
        <input id="deliveryPerson" placeholder="Your name" disabled>
      </div>
      <div class="col field">
        <label for="notes">Notes</label>
        <input id="notes" placeholder="Any notes" disabled>
      </div>
    </div>

    <div class="actions">
      <button id="submitBtn" onclick="submitUpdate()" disabled>
        <span id="btnText">Submit Update</span>
        <span id="btnSpinner" class="small-spinner" style="display:none;margin-left:6px"></span>
      </button>
      <button class="ghost" onclick="openCreateModal()">Create Order</button>
    </div>

    <div class="note">Once marked Delivered, prior statuses cannot be reapplied.</div>
    <div id="historyPreview"></div>
    <div class="comm-buttons" style="margin-top:8px">
      <button id="sendEmailBtn" class="ghost" onclick="sendEmail()" disabled>Send Email</button>
      <button id="openWhatsBtn" class="ghost" onclick="openWhatsApp()" disabled>Open WhatsApp</button>
    </div>
  </div>
</div>

<!-- Modals (create & scanner) remain same structure -->

<script>
// ALL your original JS functionality unchanged
</script>
</body>
</html>
