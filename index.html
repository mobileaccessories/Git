<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>Passcode + QR — Mark Delivered</title>
<!-- styles unchanged from your original (kept for brevity) -->
<style>
/* (paste the same CSS you already had here) */
:root{
  --pass-len:6;
  --bg:#ffffff;
  --fg:#000;
  --muted:rgba(0,0,0,0.35);
  --accent:#000;
  --success:#1a7f37;
  --danger:#b10000;
  --card-radius:16px;
  --key-size:70px;
  --key-gap:14px;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
html,body{height:100%;margin:0;font-family:-apple-system, 'Segoe UI', Roboto, Helvetica, Arial; background:var(--bg); color:var(--fg); overflow:hidden; display:flex; align-items:center; justify-content:center}
.device{width:100vw;max-width:420px;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:18px}
body.dimmed { background:#f3f4f6; }
body.dimmed #pass-screen { visibility:hidden; }
.title{font-size:22px;font-weight:600;text-align:center}
.subtitle{font-size:13px;color:var(--muted);text-align:center;margin-top:6px}
.dots{display:flex;justify-content:center;gap:16px;margin:18px 0}
.dot{width:12px;height:12px;border-radius:50%;border:1px solid var(--muted);background:transparent;transition:transform .15s,background .15s}
.dot.filled{background:var(--fg);transform:scale(1.2)}
.keypad{display:grid;grid-template-columns:repeat(3,var(--key-size));grid-template-rows:repeat(4,var(--key-size));gap:var(--key-gap);justify-content:center;margin-bottom:12px}
.key{width:var(--key-size);height:var(--key-size);border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.05);cursor:pointer;border:none}
.key:active{background:rgba(0,0,0,0.12)}
.num{font-size:22px}
.letters{font-size:10px;color:var(--muted);margin-top:3px}
.controls-grid{width: calc(var(--key-size) * 3 + var(--key-gap) * 2); display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--key-gap); justify-items: center; align-items: center; margin-top:6px;}
.bottom-row{width:100%;display:flex;justify-content:space-between;padding:0 6px}
.btn-text{color:var(--muted);background:rgba(0,0,0,0.05);border:none;padding:8px 14px;border-radius:10px;cursor:pointer}
.btn-cancel{font-weight:700}
#emergencyBtn{color:var(--danger);font-weight:600;background:rgba(177,0,0,0.08)}
#emergencyBtn:active{background:rgba(177,0,0,0.15)}
#status{margin-top:12px;text-align:center;color:var(--muted);font-size:13px;min-height:20px;line-height:20px;box-sizing:border-box;}
#scanner-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:50;padding:20px}
#scanner-card{width:92vw;max-width:420px;background:#fff;border-radius:var(--card-radius);overflow:hidden;box-shadow:0 20px 50px rgba(0,0,0,0.35);display:flex;flex-direction:column;align-items:center;padding:12px}
#reader{width:100%;height:320px;background:#000;border-radius:12px;overflow:hidden}
.scan-controls{width:100%;display:flex;gap:10px;margin-top:12px}
.scan-controls button{flex:1;padding:12px;border-radius:999px;border:none;cursor:pointer;font-weight:700}
#result-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;display:none;align-items:center;justify-content:center;background:var(--bg);z-index:60;padding:20px}
.result-card{width:94vw;max-width:460px;border-radius:18px;padding:28px;box-shadow:0 20px 60px rgba(0,0,0,0.08);background:linear-gradient(180deg,#ffffff,#fbfbfb);text-align:center}
.result-title{font-size:20px;font-weight:700;margin-bottom:8px}
.result-sub{font-size:13px;color:var(--muted);margin-bottom:18px}
.result-msg{font-size:16px;margin:14px 0;min-height:58px}
.result-controls{display:flex;gap:12px;justify-content:center;margin-top:12px}
.btn-primary{background:var(--accent);color:#fff;border:none;padding:12px 18px;border-radius:12px;font-weight:700;cursor:pointer}
.btn-secondary{background:#f3f4f6;color:#000;border:none;padding:12px 18px;border-radius:12px;cursor:pointer}
.hidden{display:none!important}
@media (max-width:360px){ :root{ --key-size:60px; --key-gap:12px; } .num{font-size:18px} }
</style>
</head>
<body>
  <div class="device" id="container">
    <!-- PASS SCREEN -->
    <div id="pass-screen" aria-live="polite">
      <div class="title">Enter Passcode</div>
      <div id="status" style="text-align:center;color:var(--muted);font-size:13px"></div>

      <div class="dots" id="dots"></div>

      <!-- keypad -->
      <div class="keypad" id="keypad" aria-hidden="false"></div>

      <div class="controls-grid" aria-hidden="false">
        <div style="display:flex;align-items:center;justify-content:center;">
          <button id="emergencyBtn" class="btn-text">Emergency</button>
        </div>
        <div></div>
        <div style="display:flex;align-items:center;justify-content:center;">
          <button id="clearBtn" class="btn-text btn-cancel">Clear</button>
        </div>
      </div>

    </div>
  </div>

  <!-- scanner overlay -->
  <div id="scanner-overlay" role="dialog" aria-hidden="true">
    <div id="scanner-card">
      <div id="reader"></div>
      <div class="scan-controls" style="width:100%; margin-top:10px">
        <button id="backToPass" class="btn-scan-back">Back</button>
        <button id="cancelScanBtn" class="btn-scan-cancel">Cancel</button>
      </div>
      <div id="scanHint" style="font-size:13px;color:var(--muted);margin-top:10px">Point camera at the QR code</div>
    </div>
  </div>

  <!-- result overlay -->
  <div id="result-overlay" role="dialog" aria-hidden="true">
    <div class="result-card" id="result-card">
      <div class="result-title" id="result-title">Status</div>
      <div class="result-sub" id="result-sub">Order • Passcode</div>

      <div class="result-msg" id="result-msg">Waiting...</div>

      <div class="result-controls" id="result-controls">
        <button id="nextUpdateBtn" class="btn-primary">Next Update</button>
        <button id="closeResultBtn" class="btn-secondary">Close</button>
      </div>

      <div id="result-note" style="margin-top:12px;color:var(--muted);font-size:13px">Scan time and quick location (if available) will be sent with the update.</div>
    </div>
  </div>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
  (function(){
    document.documentElement.style.touchAction = 'none';
    ['contextmenu','copy','cut','selectstart'].forEach(ev => document.addEventListener(ev, e=>e.preventDefault()));

    const PASS_LEN = 6;
    const KEYS = [
      {n:'1',l:''},{n:'2',l:''},{n:'3',l:''},
      {n:'4',l:''},{n:'5',l:''},{n:'6',l:''},
      {n:'7',l:''},{n:'8',l:''},{n:'9',l:''},
    ];

    const keypad = document.getElementById('keypad');
    const dots = document.getElementById('dots');
    const clearBtn = document.getElementById('clearBtn');
    const emergencyBtn = document.getElementById('emergencyBtn');
    const statusEl = document.getElementById('status');

    const scannerOverlay = document.getElementById('scanner-overlay');
    const backToPassBtn = document.getElementById('backToPass');
    const cancelScanBtn = document.getElementById('cancelScanBtn');

    const resultOverlay = document.getElementById('result-overlay');
    const resultTitle = document.getElementById('result-title');
    const resultSub = document.getElementById('result-sub');
    const resultMsg = document.getElementById('result-msg');
    const nextUpdateBtn = document.getElementById('nextUpdateBtn');
    const closeResultBtn = document.getElementById('closeResultBtn');

    let entry = '';
    let html5QrCode = null;
    let inFlight = false;
    let locationPromise = null;

    let pending = {
      order: null,
      passcode: null,
      scanTime: null,
      location: null,
      checkResp: null,
      deliveryPersonFromQr: null
    };

    // create dots
    for(let i=0;i<PASS_LEN;i++){ const d=document.createElement('div'); d.className='dot'; dots.appendChild(d); }

    // build keypad
    const frag = document.createDocumentFragment();
    for(let i=0;i<9;i++){
      const k=KEYS[i];
      const btn=document.createElement('button'); btn.type='button'; btn.className='key';
      btn.setAttribute('data-num',k.n); btn.innerHTML=`<div class="num">${k.n}</div><div class="letters">${k.l}</div>`;
      frag.appendChild(btn);
    }
    const phLeft = document.createElement('div'); phLeft.style.width = "var(--key-size)"; frag.appendChild(phLeft);
    const zeroKey=document.createElement('button'); zeroKey.type='button'; zeroKey.className='key';
    zeroKey.setAttribute('data-num','0'); zeroKey.innerHTML=`<div class="num">0</div><div class="letters"></div>`;
    frag.appendChild(zeroKey);
    const phRight = document.createElement('div'); phRight.style.width = "var(--key-size)"; frag.appendChild(phRight);
    keypad.appendChild(frag);

    function updateDots(){ Array.from(dots.children).forEach((d,i)=>d.classList.toggle('filled', i<entry.length)); }
    function setStatus(msg){ statusEl.textContent = msg || ''; }

    function getLocationPromise(timeoutMs=2000){
      if (locationPromise) return locationPromise;
      locationPromise = new Promise(resolve=>{
        if (!navigator.geolocation) return resolve(null);
        let done=false;
        const t=setTimeout(()=>{ if(!done){ done=true; resolve(null); } }, timeoutMs);
        navigator.geolocation.getCurrentPosition(pos=>{ if(done) return; done=true; clearTimeout(t); resolve({lat:pos.coords.latitude,lng:pos.coords.longitude}); }, err=>{ if(done) return; done=true; clearTimeout(t); resolve(null); }, {enableHighAccuracy:false, timeout:timeoutMs});
      });
      return locationPromise;
    }
    function resetLocationPromise(){ locationPromise=null; }

    function setInFlight(val){
      inFlight = !!val;
      if (inFlight){ keypad.classList.add('disabled'); clearBtn.disabled = true; emergencyBtn.disabled = true; nextUpdateBtn.disabled = true; }
      else { keypad.classList.remove('disabled'); clearBtn.disabled = false; emergencyBtn.disabled = false; nextUpdateBtn.disabled = false; }
    }

    keypad.addEventListener('pointerdown', ev=>{
      ev.preventDefault();
      if (inFlight) return;
      const btn = ev.target.closest('.key'); if(!btn) return;
      const n = btn.getAttribute('data-num'); if(!n) return;
      if (entry.length >= PASS_LEN) return;
      entry += n; updateDots(); setStatus('');
      if (entry.length === PASS_LEN){
        setStatus('Passcode entered — opening scanner…');
        setTimeout(()=>openScannerWithPass(entry), 220);
      }
    });

    clearBtn.addEventListener('click', e=>{ e.preventDefault(); if(inFlight) return; entry=''; updateDots(); setStatus(''); });
    emergencyBtn.addEventListener('click', e=>{ e.preventDefault(); setStatus('Emergency pressed — implement as needed'); });

    function openScannerWithPass(passcode){
      resetLocationPromise();
      document.body.classList.add('dimmed');
      scannerOverlay.style.display='flex';
      scannerOverlay.setAttribute('aria-hidden','false');
      startScanner(passcode);
    }

    function stopAndClearScanner(){
      document.body.classList.remove('dimmed');
      if (!html5QrCode){ scannerOverlay.style.display='none'; scannerOverlay.setAttribute('aria-hidden','true'); return Promise.resolve(); }
      return html5QrCode.stop().catch(()=>{}).then(()=>{ try{ html5QrCode.clear(); } catch(e){} html5QrCode=null; scannerOverlay.style.display='none'; scannerOverlay.setAttribute('aria-hidden','true'); });
    }

    function onScanSuccess(qrMessage, passcode){
      stopAndClearScanner().then(()=>{
        const payload = (qrMessage || '').trim();
        let orderVal = payload;
        let deliveryPersonFromQr = null;

        // parse flexible payloads:
        // - "ORDER"
        // - "ORDER|ACCESS"
        // - "ORDER|ACCESS|DELIVERYPERSON"
        // - "ORDER,ACCESS" etc.
        let parts = [];
        if (payload.includes('|')) parts = payload.split('|').map(s=>s.trim());
        else if (payload.includes(',')) parts = payload.split(',').map(s=>s.trim());
        else parts = [payload];

        if (parts.length >= 1) orderVal = parts[0] || '';
        if (parts.length >= 3) deliveryPersonFromQr = parts[2] || null;
        // sometimes QR contains access too (we already use passcode entered separately), but keep parts[1] unused here.

        orderVal = (orderVal || '').trim();
        if (!orderVal){
          setStatus('QR did not contain a valid order identifier'); return;
        }

        pending.order = orderVal;
        pending.passcode = passcode;
        pending.scanTime = new Date().toISOString();
        pending.location = null;
        pending.checkResp = null;
        pending.deliveryPersonFromQr = deliveryPersonFromQr;

        setStatus('Got QR — validating…'); setInFlight(true);

        getLocationPromise(2000).then(coords=>{
          pending.location = coords ? JSON.stringify(coords) : '';
          if (window.google && google.script && google.script.run){
            google.script.run.withSuccessHandler(checkResp=>{
              setInFlight(false);
              pending.checkResp = checkResp || null;
              if (!checkResp){ showResult('Error', 'Empty response from server', 'error', false); return; }
              if (checkResp.error){ showResult('Error', checkResp.message || 'Order check failed', 'error', false); return; }

              const canonical = (checkResp.canonicalStatus || '').toString().toLowerCase();
              const statusText = (checkResp.status || checkResp.message || '').toString().toLowerCase();

              if (canonical === 'out for delivery' || statusText.indexOf('out') !== -1){ showResult('Ready to mark as delivered', `Order: ${pending.order} • Pass: ${pending.passcode}`, 'info', true); }
              else if (canonical === 'delivered' || statusText.indexOf('deliver') !== -1){ showResult('Already delivered', `Order: ${pending.order}`, 'error', false); }
              else if (canonical === 'cancelled' || statusText.indexOf('cancel') !== -1){ showResult('Order cancelled', `Order: ${pending.order}`, 'error', false); }
              else { showResult('Not eligible', (checkResp.status || 'Unknown status'), 'error', false); }

            }).withFailureHandler(err=>{ setInFlight(false); showResult('Server error', (err && err.message) ? err.message : String(err), 'error', false); }).checkOrderStatus(pending.order, pending.passcode);
          } else {
            setInFlight(false);
            showResult('Local mode', `Detected order: ${pending.order}`, 'info', true);
          }
        });
      });
    }

    function startScanner(passcode){
      if (html5QrCode) return;
      html5QrCode = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(devices=>{
        if (!devices || devices.length === 0){
          setStatus('No camera found'); document.body.classList.remove('dimmed'); scannerOverlay.style.display='none'; html5QrCode=null; return;
        }
        const config = { fps:10, qrbox:function(w,h){ const m=Math.min(w,h); return {width:Math.floor(m*0.9), height:Math.floor(m*0.6)} } };
        html5QrCode.start({facingMode:"environment"}, config, qrMessage=>{ onScanSuccess(qrMessage, entry); }, decodeErr=>{}).catch(err=>{ setStatus('Unable to start camera: ' + (err && err.message ? err.message : err)); document.body.classList.remove('dimmed'); scannerOverlay.style.display='none'; html5QrCode=null; });
      }).catch(err=>{ setStatus('Camera access error: ' + (err && err.message ? err.message : err)); document.body.classList.remove('dimmed'); scannerOverlay.style.display='none'; html5QrCode=null; });
    }

    backToPassBtn.addEventListener('click', e=>{ e.preventDefault(); stopAndClearScanner().then(()=>{ entry=''; updateDots(); setStatus(''); }); });
    cancelScanBtn.addEventListener('click', e=>{ e.preventDefault(); stopAndClearScanner().then(()=>{ entry=''; updateDots(); setStatus('Scan cancelled'); }); });

    function showResult(title, subtitle, tone='info', allowUpdate=false){
      resultTitle.textContent = title;
      resultSub.textContent = subtitle;
      resultMsg.textContent = '';
      if (tone === 'success') { resultMsg.style.color = 'var(--success)'; }
      else if (tone === 'error'){ resultMsg.style.color = 'var(--danger)'; }
      else { resultMsg.style.color = 'var(--muted)'; }

      if (allowUpdate){ resultMsg.textContent = 'Tap Next Update to confirm and push the delivery update.'; nextUpdateBtn.style.display = 'inline-block'; }
      else { nextUpdateBtn.style.display = 'none'; resultMsg.textContent = subtitle; }

      resultOverlay.style.display = 'flex'; resultOverlay.setAttribute('aria-hidden','false');
      document.getElementById('pass-screen').style.visibility = 'hidden';
    }

    function closeResult(){
      resultOverlay.style.display = 'none'; resultOverlay.setAttribute('aria-hidden','true');
      document.getElementById('pass-screen').style.visibility = 'visible';
      entry=''; updateDots(); setStatus('');
      pending = { order:null, passcode:null, scanTime:null, location:null, checkResp:null, deliveryPersonFromQr: null };
      resetLocationPromise();
    }

    // Updated Next Update handler: calls markAsDeliveredFromHtml (server wrapper that sends email)
    nextUpdateBtn.addEventListener('click', e=>{
      e.preventDefault();
      if (!pending.order || !pending.passcode) return;
      setInFlight(true);
      resultMsg.textContent = 'Sending update…'; resultMsg.style.color = 'var(--muted)';

      // pick deliveredBy: prefer QR payload value, otherwise label as 'QR Auto'
      const deliveredBy = (pending.deliveryPersonFromQr && String(pending.deliveryPersonFromQr).trim()) ? String(pending.deliveryPersonFromQr).trim() : 'QR Auto';

      if (window.google && google.script && google.script.run){
        google.script.run.withSuccessHandler(markResp=>{
          setInFlight(false);
          // markResp expected shape: { success: true/false, message:..., email: { success: true/false, ... } }
          if (markResp && markResp.success){
            // success: show delivered + email status if present
            if (markResp.email && typeof markResp.email === 'object') {
              if (markResp.email.success) {
                resultMsg.textContent = 'Order marked delivered ✅ — confirmation email sent.';
                resultMsg.style.color = 'var(--success)';
              } else {
                resultMsg.textContent = 'Order marked delivered ✅ — email failed: ' + (markResp.email.error || 'unknown');
                resultMsg.style.color = 'var(--danger)';
              }
            } else {
              resultMsg.textContent = 'Order marked delivered ✅';
              resultMsg.style.color = 'var(--success)';
            }
            nextUpdateBtn.style.display = 'none';
            closeResultBtn.textContent = 'Done';
          } else {
            const msg = (markResp && (markResp.message || markResp.error)) || 'Failed to mark delivered';
            resultMsg.textContent = msg;
            resultMsg.style.color = 'var(--danger)';
          }
        }).withFailureHandler(err=>{ setInFlight(false); resultMsg.textContent = 'Server error: ' + ((err && err.message) ? err.message : err); resultMsg.style.color = 'var(--danger)'; })
        .markAsDeliveredFromHtml(pending.order, pending.passcode, pending.scanTime || new Date().toISOString(), pending.location || '', deliveredBy);
      } else {
        setTimeout(()=>{ setInFlight(false); resultMsg.textContent = 'Simulated: Order marked as delivered '; resultMsg.style.color = 'var(--success)'; nextUpdateBtn.style.display = 'none'; closeResultBtn.textContent = 'Done'; }, 800);
      }
    });

    closeResultBtn.addEventListener('click', e=>{ e.preventDefault(); closeResult(); });

    window.addEventListener('beforeunload', e=>{ if (inFlight){ e.preventDefault(); e.returnValue=''; } });

    updateDots(); setStatus('Enter your 6-digit passcode');
  })();
  </script>
</body>
</html>
