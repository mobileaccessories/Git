<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Track Order â€” Chat & Return (Updated)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root {
      --bg:#ffffff;
      --card:#fff;
      --text:#1f1f1f;
      --muted:#6f6f6f;
      --border:#e4e7ec;
      --accent:#111;
      --radius:12px;
      --shadow:0 22px 80px -16px rgba(0,0,0,0.08);
      --font: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      --transition:.25s cubic-bezier(.4,.2,.2,1);
      --max:980px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font);-webkit-font-smoothing:antialiased;padding:28px 16px}
    .container{max-width:var(--max);margin:0 auto;padding:0 12px}
    h1{margin:0;font-size:2.1rem;font-weight:700}
    .sub{margin:8px 0 22px;font-size:0.95rem;color:var(--muted)}

    /* form */
    .form-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;align-items:flex-start}
    .field-wrapper{position:relative;flex:1;min-width:160px}
    .floating-input{width:100%;padding:16px 14px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:1rem;outline:none;transition:all var(--transition);position:relative}
    .floating-input:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(17,17,17,0.06)}
    .floating-label{position:absolute;top:14px;left:14px;pointer-events:none;font-size:0.65rem;color:var(--muted);background:var(--card);padding:0 4px;transition:all var(--transition);transform-origin:left top}
    .has-value .floating-label, .floating-input:focus + .floating-label{transform: translateY(-8px) scale(.85);background: var(--bg);color:var(--accent)}
    .small{font-size:0.65rem;color:var(--muted);margin-top:4px}
    .track-btn{padding:16px 28px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;font-size:1rem;display:inline-flex;align-items:center;gap:8px;flex-shrink:0}
    .track-btn:hover{filter:brightness(1.06)}

    /* cards */
    .card{background:var(--card);border-radius:var(--radius);padding:24px 26px;margin-bottom:24px;position:relative;border:1px solid var(--border);box-shadow:var(--shadow);transition:box-shadow .18s ease;overflow:hidden}
    .cancel-banner{display:block;padding:8px 12px;margin-bottom:12px;background: linear-gradient(90deg, rgba(231,179,179,0.12), rgba(255,255,255,0));color:#7a2f2f;border-bottom:1px solid rgba(244,199,199,0.5);font-weight:700;letter-spacing:0.4px;border-radius:8px}

    /* progress (legacy sizes preserved) */
    .progress{margin-bottom:22px;position:relative}
    .progress-steps{display:flex;gap:8px;position:relative;padding:0;list-style:none;margin:0}
    .step{flex:1;position:relative;display:flex;flex-direction:column;align-items:center;font-size:0.55rem;text-align:center;color:var(--muted);z-index:1;cursor:pointer}
    .step-circle{width:28px;height:28px;border-radius:50%;background:#e8ebf0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;position:relative;transition:all var(--transition)}
    .step.completed .step-circle{background:var(--accent);color:#fff}
    .step-label{margin-top:6px;line-height:1.2;max-width:120px}
    .connector{position:absolute;top:14px;left:0;right:0;height:4px;background:#e8ebf0;border-radius:2px;z-index:0;overflow:hidden}
    .connector-fill{height:100%;background:var(--accent);width:0;transition:width var(--transition);border-radius:2px}

    /* compact progress for small places */
    .progress.compact .progress-steps{gap:6px}
    .progress.compact .step-circle{width:22px;height:22px;font-size:11px}
    .progress.compact .connector{height:4px;top:14px}
    .progress.compact .step-label{display:none}
    .progress.compact .step:hover .step-label{display:block;position:absolute;top:36px;left:50%;transform:translateX(-50%);background:var(--card);padding:6px 8px;border-radius:8px;box-shadow:var(--shadow);font-size:0.65rem}

    /* accordion/dropdown wrapper for return / order */
    .accordion {border-radius:8px;overflow:hidden}
    .accordion .acc-header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border-bottom:1px solid var(--border);cursor:pointer}
    .acc-title{font-weight:700}
    .acc-sub{font-size:0.85rem;color:var(--muted)}
    .acc-body{display:none;padding:12px}
    .accordion.open .acc-body{display:block}
    .chev{transition:transform .18s ease}
    .accordion.open .chev{transform:rotate(180deg)}

    .summary-grid{display:grid;grid-template-columns: repeat(auto-fit,minmax(150px,1fr));gap:18px;margin-top:4px}
    .field{display:flex;flex-direction:column;gap:4px}
    .label{font-size:0.55rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-weight:700}
    .value{font-size:1rem;font-weight:700}

    /* timeline uses native details for accessible accordion */
    .timeline{margin-top:14px}
    details{border-top:1px solid var(--border);padding:10px 0}
    summary{list-style:none;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:12px;font-weight:700}
    summary::-webkit-details-marker{display:none}
    .history-detail{font-size:0.95rem;color:var(--text);margin-top:8px}
    .history-meta{font-size:0.82rem;color:var(--muted);margin-top:6px}

    .error-box{background:#fff5f5;border:1px solid #e7c4c4;padding:14px 16px;border-radius:8px;color:#a33;margin-bottom:14px;font-weight:700;display:flex;align-items:center;gap:10px}
    .success-box{background:#eef8ee;border:1px solid #c9e5ca;padding:14px 16px;border-radius:8px;color:#1f5f2f;margin-bottom:14px;font-weight:700;display:flex;align-items:center;gap:10px}

    /* return button */
    .muted-btn{background:transparent;border:1px solid var(--border);padding:10px 12px;border-radius:8px;cursor:pointer}
    .muted-btn:hover{box-shadow:0 6px 18px rgba(0,0,0,0.04)}

    /* cancel-specific styling (keeps aesthetic) */
    .cancel-btn{background:transparent;border:1px solid rgba(250,120,120,0.18);padding:10px 12px;border-radius:8px;cursor:pointer;color:#a33;font-weight:700}
    .cancel-btn:hover{background:rgba(250,120,120,0.04)}

    /* chat */
    .chat-bubble{position:fixed;right:20px;bottom:22px;width:56px;height:56px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;box-shadow:0 8px 34px rgba(17,17,17,0.18);z-index:1200}
    .chat-panel{position:fixed;right:20px;bottom:92px;width:360px;max-width:92vw;height:520px;border-radius:12px;background:var(--card);box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden;z-index:1200;border:1px solid var(--border)}
    .chat-header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .chat-messages{flex:1;padding:12px;overflow:auto;background:linear-gradient(180deg,#fff,#fbfbfd)}
    .chat-input{display:flex;padding:10px;border-top:1px solid var(--border);gap:8px}
    .msg{max-width:78%;padding:8px 10px;border-radius:10px;margin-bottom:8px;font-size:0.92rem}
    .msg.user{background:var(--accent);color:#fff;margin-left:auto;text-align:right}
    .msg.bot{background:#f1f4f8;color:var(--text)}
    .chat-placeholder{color:var(--muted);font-size:0.9rem;padding:16px;text-align:center}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(16,16,16,0.36);display:flex;align-items:center;justify-content:center;z-index:1250}
    .modal{width:520px;max-width:94vw;border-radius:12px;background:var(--card);padding:18px;border:1px solid var(--border);box-shadow:var(--shadow)}
    .modal h3{margin:0 0 8px}
    .row{display:flex;gap:8px}
    .col{flex:1}

    /* utilities */
    .actions{display:flex;gap:8px;margin-top:12px}
    .meta-row{display:flex;gap:8px;align-items:center}

    /* legacy loader + placeholder from older version */
    .loader-small {display:inline-block;width:14px;height:14px;border:2px solid rgba(0,0,0,0.15);border-left-color:#111;border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-right:6px}
    @keyframes spin { to { transform: rotate(360deg); } }
    .placeholder {background: linear-gradient(90deg, rgba(245,245,245,1) 25%, rgba(235,235,235,1) 50%, rgba(245,245,245,1) 75%);background-size:200% 100%;animation: shimmer 1.4s ease-in-out infinite;border-radius:6px}
    @keyframes shimmer { to { background-position: -200% 0; } }

    @media (max-width:880px){.chat-panel{right:12px;left:12px;width:auto;height:52vh;bottom:86px}}
    @media (max-width:520px){.history-time{display:none}}
  </style>
</head>
<body>
  <div class="container" aria-label="Order tracking">
    <h1>Track Your Order</h1>
    <div class="sub">Enter your order number and access code to see live status. Use the chat bubble to ask questions or start a return.</div>

    <div class="card" aria-label="Search panel">
      <div class="form-row">
        <div class="field-wrapper" style="flex:2;">
          <input id="orderInput" class="floating-input" aria-label="Order number" autocomplete="off" />
          <label class="floating-label" for="orderInput">Order number</label>
        </div>
        <div class="field-wrapper" style="flex:1; min-width:140px;">
          <input id="codeInput" class="floating-input" aria-label="Access code" autocomplete="off" />
          <label class="floating-label" for="codeInput">Access code</label>
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button class="track-btn" id="trackBtn" aria-label="Track order">
            <span>Track</span>
          </button>
        </div>
      </div>
      <div class="small">You can copy the tracking link with order & code in URL to prefill next time.</div>
    </div>

    <div id="messageArea" aria-live="polite"></div>
    <div id="result"></div>
  </div>

  <!-- Chat bubble + panel -->
  <div class="chat-bubble" id="chatToggle" title="Chat with support" aria-label="Open chat" onclick="toggleChat()">ðŸ’¬</div>
  <div id="chatPanel" class="chat-panel" style="display:none" role="dialog" aria-label="Support chat">
    <div class="chat-header">
      <div style="font-weight:700">Support</div>
      <button onclick="toggleChat()" aria-label="Close chat" class="muted-btn">Close</button>
    </div>
    <div id="chatMessages" class="chat-messages">
      <div class="chat-placeholder">Start a conversation â€” we reply instantly. Include your order number for a faster answer.</div>
    </div>
    <div class="chat-input">
      <input id="chatInput" class="floating-input" style="padding:10px;border-radius:8px;border:1px solid var(--border);flex:1" placeholder="Type a message..." />
      <button class="track-btn" onclick="sendChat()">Send</button>
    </div>
  </div>

  <!-- Modal root -->
  <div id="modalRoot" style="display:none"></div>

  <script>
    // === Configuration (set your Apps Script Web App URL here) ===
    const API_URL = 'https://script.google.com/macros/s/AKfycbyL1NbhX3pYQipkXuVpNEZijNYHNOTpHnPbO9mJD_TktrapXogPxHsQ_8Riz1--QNWHcw/exec'; // <-- Replace with your URL
    const STEPS = ['Order Placed','Picked up','Out for delivery','Delivered'];
    const RETURN_STEPS = ['Return Requested','Pickup Scheduled','Return Picked Up','Inspection','Refund/Replacement','Replacement Shipped','Replacement Delivered'];
    const TIMEOUT_MS = 12000;

    // --- Helpers ---
    function formatDate(d) {
      if (!d) return 'â€”';
      const dt = new Date(d);
      if (isNaN(dt)) return 'â€”';
      return dt.toLocaleString(undefined,{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:true}).replace(/,/g,'');
    }

    function showMessage(text, type='error'){
      const area=document.getElementById('messageArea');
      if(!text){area.innerHTML='';return}
      if(type==='error') area.innerHTML=`<div class="error-box" role="alert"><div>${text}</div></div>`;
      else area.innerHTML=`<div class="success-box" role="status"><div>${text}</div></div>`;
    }

    function setFloatingLabels(){
      document.querySelectorAll('.field-wrapper').forEach(w=>{
        const input=w.querySelector('.floating-input'); if(!input) return;
        const update = ()=>{ input.value.trim()? w.classList.add('has-value') : w.classList.remove('has-value'); };
        update();
        input.addEventListener('input', update);
        input.addEventListener('focus', ()=>w.classList.add('has-value'));
      });
    }

    function persistSession(order, code){
      try{
        localStorage.setItem('tracking_order',order);
        localStorage.setItem('tracking_code',code);
        const params=new URLSearchParams(window.location.search);
        params.set('order',order);
        params.set('code',code);
        window.history.replaceState({},'',`${location.pathname}?${params}`);
      }catch{}
    }
    function loadSession(){ try{ return { order: localStorage.getItem('tracking_order')||'', code: localStorage.getItem('tracking_code')||'' } }catch{return {order:'',code:''}} }

    function canonicalStatusLocal(s){
      if(!s) return '';
      const t=s.toLowerCase().trim().replace(/\s+/g,' ');
      if(['cancelled','canceled','cancel','order cancelled','order canceled'].includes(t)) return 'cancelled';
      if(t.includes('cancel')) return 'cancelled';
      if(t.includes('return')) return 'return';
      return t;
    }

    function getStepIndex(status, steps){
      if(!status) return 0;
      const s=status.toLowerCase();
      for(let i=0;i<steps.length;i++){
        if(s.includes(steps[i].toLowerCase().split(' ')[0])) return i;
      }
      if(s.includes('placed')) return 0;
      if(s.includes('picked')) return 1;
      if(s.includes('out')) return 2;
      if(s.includes('deliver')) return 3;
      return 0;
    }

    function renderProgressFor(steps, currentStatus, opts){
      opts = opts || {};
      const compact = !!opts.compact;
      const idxRaw = getStepIndex(currentStatus, steps);
      const isCancelled = canonicalStatusLocal(currentStatus)==='cancelled';
      const idx = isCancelled? -1: idxRaw;

      const container = document.createElement('div'); container.className = 'card';
      const progressWrap = document.createElement('div'); progressWrap.className = compact? 'progress compact' : 'progress';
      progressWrap.setAttribute('role','progressbar');
      progressWrap.setAttribute('aria-valuemin','0');
      progressWrap.setAttribute('aria-valuemax', String(Math.max(steps.length-1,1)));
      progressWrap.setAttribute('aria-valuenow', String(Math.max(idx,0)));

      const connector = document.createElement('div'); connector.className='connector'; connector.setAttribute('aria-hidden','true'); connector.innerHTML = '<div class="connector-fill" style="width:0%"></div>';
      const stepsRow = document.createElement('div'); stepsRow.className='progress-steps';

      steps.forEach((label,i)=>{
        const step = document.createElement('div'); step.className='step'; step.dataset.index = i; step.dataset.label = label; step.tabIndex = 0;
        const completed = !isCancelled && i<=idx;
        if(completed) step.classList.add('completed');
        if(i===idx) step.setAttribute('aria-current','true');
        step.innerHTML = `<div class="step-circle">${completed? '&#10003;' : (i+1)}</div><div class="step-label">${label}</div>`;
        step.addEventListener('click', ()=>{
          showMessage(`${label} â€” ${completed? 'Completed' : 'Pending'}`, 'success');
          setTimeout(()=>{ showMessage(''); }, 2000);
        });
        step.addEventListener('keyup', (e)=>{ if(e.key==='Enter' || e.key===' ') step.click(); });
        stepsRow.appendChild(step);
      });

      progressWrap.appendChild(connector);
      progressWrap.appendChild(stepsRow);
      container.appendChild(progressWrap);

      return {el:container, idx, isCancelled};
    }

    function adjustProgressFill(container, idx){
      const progressContainer = container.querySelector('.progress'); if(!progressContainer) return; const fill = progressContainer.querySelector('.connector-fill'); const steps = progressContainer.querySelectorAll('.step');
      if(idx<0){ fill.style.width='0%'; steps.forEach(s=>s.classList.remove('completed')); return; }
      if(!steps[idx]) return;
      const bar = progressContainer.querySelector('.connector');
      const barRect = bar.getBoundingClientRect();
      const stepCircles = Array.from(steps).map(s=>s.querySelector('.step-circle'));
      const centers = stepCircles.map(c=> ({left: c.getBoundingClientRect().left + c.getBoundingClientRect().width/2}));
      const activeCenter = centers[idx].left - barRect.left;
      let targetPx = Math.max(0, Math.min(barRect.width, activeCenter));
      targetPx = Math.min(barRect.width, targetPx + (stepCircles[idx].getBoundingClientRect().width*0.15));
      fill.style.width = (targetPx/barRect.width*100) + '%';
      steps.forEach((s,i)=>{ if(i<=idx) s.classList.add('completed'); else s.classList.remove('completed'); s.removeAttribute('aria-current'); });
      if(steps[idx]) steps[idx].setAttribute('aria-current','true');
      progressContainer.setAttribute('aria-valuenow', String(idx));
    }

    function showLoadingSkeleton(){ const html=`<div class="card"><div class="placeholder" style="height:20px;width:60%;margin-bottom:16px;border-radius:6px"></div><div class="summary-grid"><div class="field"><div class="label placeholder" style="height:12px;width:80px"></div><div class="value placeholder" style="height:16px;width:120px;margin-top:6px"></div></div><div class="field"><div class="label placeholder" style="height:12px;width:80px"></div><div class="value placeholder" style="height:16px;width:120px;margin-top:6px"></div></div><div class="field"><div class="label placeholder" style="height:12px;width:80px"></div><div class="value placeholder" style="height:16px;width:120px;margin-top:6px"></div></div></div></div>`; document.getElementById('result').innerHTML=html; }

    async function fetchOrderData(order, code){
      if(!API_URL || API_URL.includes('YOUR_SCRIPT_ID')) return {error:'API_URL not configured.'};
      const url=`${API_URL}?order=${encodeURIComponent(order)}&code=${encodeURIComponent(code)}`;
      const controller=new AbortController(); const timeout=setTimeout(()=>controller.abort(),TIMEOUT_MS);
      try{
        const response = await fetch(url,{method:'GET',mode:'cors',cache:'no-store',signal:controller.signal});
        clearTimeout(timeout);
        if(!response.ok) return {error:`HTTP ${response.status}`};
        const data=await response.json();
        return data;
      }catch(err){
        clearTimeout(timeout);
        return {error:err.message||'Fetch failed'};
      }
    }

    // Main search
    async function search(){
      const order=document.getElementById('orderInput').value.trim();
      const code=document.getElementById('codeInput').value.trim();
      if(!order){ showMessage('Order number required.'); return; }
      if(!code){ showMessage('Access code required.'); return; }
      showMessage(''); showLoadingSkeleton();
      const resp = await fetchOrderData(order, code);
      if(!resp || resp.error){ renderError(resp?resp.error:'Unknown error'); return; }
      persistSession(order, code);
      saveLastResponse(order, resp);
      render(resp);
    }

    function renderError(msg){ document.getElementById('result').innerHTML=''; showMessage(msg,'error'); }

    function saveReturnData(order, data){ try{ localStorage.setItem('return_'+order, JSON.stringify(data)); }catch{} }
    function loadReturnData(order){ try{ const d=localStorage.getItem('return_'+order); return d?JSON.parse(d):null }catch{return null } }

    function saveCancelFlag(order, data){ try{ localStorage.setItem('cancel_'+order, JSON.stringify(data)); }catch{} }
    function loadCancelFlag(order){ try{ const d=localStorage.getItem('cancel_'+order); return d?JSON.parse(d):null }catch{return null } }

    function saveChat(order, chat){ try{ localStorage.setItem('chat_'+order, JSON.stringify(chat)); }catch{} }
    function loadChat(order){ try{ const d=localStorage.getItem('chat_'+order); return d?JSON.parse(d):[] }catch{return [] } }

    function render(resp){
      document.getElementById('result').innerHTML='';
      if(resp.error){ renderError(resp.error); return; }
      const o = resp.order || {};
      const orderKey = o.OrderNumber||o.order||'';

      // ORDER card
      const orderCard = document.createElement('div'); orderCard.className='card';
      const orderAcc = document.createElement('div'); orderAcc.className='accordion';
      const orderHeader = document.createElement('div'); orderHeader.className='acc-header';

      const orderTitle = document.createElement('div');
      orderTitle.innerHTML = `<div class="acc-title">Order â€” ${orderKey || '-'}</div><div class="acc-sub">${o.CurrentStatus||o.Status||'Status unknown'}</div>`;

      const orderMeta = document.createElement('div'); orderMeta.className='meta-row';
      orderMeta.innerHTML = `<button class="muted-btn" id="toggleOrderBtn">View details</button>`;

      orderHeader.appendChild(orderTitle); orderHeader.appendChild(orderMeta);
      orderAcc.appendChild(orderHeader);

      const orderBody = document.createElement('div'); orderBody.className = 'acc-body';

      const p = renderProgressFor(STEPS, o.CurrentStatus || o.Status || '');
      const progressWrapper = document.createElement('div');
      if(p.isCancelled){
        const ban=document.createElement('div'); ban.className='cancel-banner'; ban.textContent='Order Cancelled';
        progressWrapper.appendChild(ban);
      }
      progressWrapper.appendChild(p.el);

      const summaryGrid = document.createElement('div'); summaryGrid.className='summary-grid';
      summaryGrid.innerHTML = `<div class="field"><div class="label">Order #</div><div class="value">${o.OrderNumber||o.order||'-'}</div></div>
        <div class="field"><div class="label">Customer</div><div class="value">${o.CustomerName||o.customer||'-'}</div></div>
        <div class="field"><div class="label">Status</div><div class="value">${o.CurrentStatus||o.Status||'-'}</div></div>
        <div class="field"><div class="label">Location</div><div class="value">${o.CurrentLocation||o.location||'-'}</div></div>
        <div class="field"><div class="label">Delivery Person</div><div class="value">${o.DeliveryPerson||'-'}</div></div>
        <div class="field"><div class="label">Last Update</div><div class="value">${formatDate(o.LastUpdate||o.updatedAt)||'-'}</div></div>`;

      const actionsWrap = document.createElement('div'); actionsWrap.className='actions';
      const cancelBtn = document.createElement('button'); cancelBtn.className='cancel-btn'; cancelBtn.textContent='Cancel order'; cancelBtn.onclick = ()=> openCancelModal(o.OrderNumber||o.order||'', o.CurrentStatus||o.Status||'');
      const openChatBtn = document.createElement('button'); openChatBtn.className='track-btn'; openChatBtn.textContent='Chat about this order'; openChatBtn.onclick = ()=>{ openChat(); const orderVal = o.OrderNumber||o.order||''; if(orderVal) document.getElementById('chatInput').placeholder = 'Message about order '+orderVal; }
      actionsWrap.appendChild(cancelBtn); actionsWrap.appendChild(openChatBtn);

      orderBody.appendChild(progressWrapper);
      orderBody.appendChild(summaryGrid);
      orderBody.appendChild(actionsWrap);

      orderAcc.appendChild(orderBody);
      orderCard.appendChild(orderAcc);
      document.getElementById('result').appendChild(orderCard);

      orderHeader.querySelector('#toggleOrderBtn').addEventListener('click', ()=>{
        orderAcc.classList.toggle('open');
        const btn = orderHeader.querySelector('#toggleOrderBtn');
        if(orderAcc.classList.contains('open')) btn.textContent = 'Hide details';
        else btn.textContent = 'View details';
        requestAnimationFrame(()=>adjustProgressFill(orderCard, p.idx));
      });

      // RETURN accordion
      const returnData = loadReturnData(orderKey) || resp.return || null;
      const retCard = document.createElement('div'); retCard.className='card';
      const acc = document.createElement('div'); acc.className='accordion';
      const accHeader = document.createElement('div'); accHeader.className='acc-header';
      const accTitle = document.createElement('div'); accTitle.innerHTML = `<div class="acc-title">Return / Replacement</div><div class="acc-sub">${returnData? (returnData.Status||'') : 'No active return'}</div>`;
      const accMeta = document.createElement('div'); accMeta.className='meta-row'; accMeta.innerHTML = `<button class="muted-btn" id="toggleReturnBtn">${returnData? 'View details' : 'Start return'}</button>`;
      accHeader.appendChild(accTitle); accHeader.appendChild(accMeta);
      acc.appendChild(accHeader);

      const accBody = document.createElement('div'); accBody.className='acc-body';
      if(returnData){
        const r = renderProgressFor(RETURN_STEPS, returnData.Status||returnData.current||'', {compact:true});
        const rWrap = document.createElement('div'); rWrap.style.marginTop='8px'; rWrap.appendChild(r.el);
        const grid = document.createElement('div'); grid.className='summary-grid'; grid.innerHTML = `<div class="field"><div class="label">Return ID</div><div class="value">${returnData.ReturnId||'-'}</div></div><div class="field"><div class="label">Type</div><div class="value">${returnData.Type||'-'}</div></div><div class="field"><div class="label">Status</div><div class="value">${returnData.Status||'-'}</div></div><div class="field"><div class="label">Requested</div><div class="value">${formatDate(returnData.RequestedAt)||'-'}</div></div>`;
        rWrap.appendChild(grid);

        if(returnData.History && returnData.History.length){
          const dList = document.createElement('div'); dList.className='timeline';
          returnData.History.forEach(h=>{
            const det = document.createElement('details');
            det.innerHTML = `<summary><div style="display:flex;justify-content:space-between;gap:12px"><div>${h.Status||'-'}</div><div class="small">${formatDate(h.Timestamp||h.ts)}</div></div></summary><div class="history-detail">${h.Notes||''}</div><div class="history-meta">By: ${h.UpdatedBy||h.by||'Customer'}</div>`;
            dList.appendChild(det);
          });
          rWrap.appendChild(dList);
        }

        accBody.appendChild(rWrap);
        acc.appendChild(accBody);
        retCard.appendChild(acc);
        document.getElementById('result').appendChild(retCard);

        accHeader.querySelector('#toggleReturnBtn').addEventListener('click', ()=>{ acc.classList.toggle('open'); requestAnimationFrame(()=>adjustProgressFill(retCard, r.idx)); if(acc.classList.contains('open')) accHeader.querySelector('#toggleReturnBtn').textContent = 'Hide details'; else accHeader.querySelector('#toggleReturnBtn').textContent = 'View details'; });

        requestAnimationFrame(()=>adjustProgressFill(retCard, r.idx));

      } else {
        accBody.innerHTML = `<div class="small">No return on file for this order. You can start a return or replacement.</div>`;
        acc.appendChild(accBody);
        retCard.appendChild(acc);
        document.getElementById('result').appendChild(retCard);
        accHeader.querySelector('#toggleReturnBtn').addEventListener('click', ()=>{ openReturnModal(orderKey); });
      }

      // timeline
      if(resp.history && resp.history.length){
        const histCard = document.createElement('div'); histCard.className='card';
        const title = document.createElement('div'); title.className='label'; title.style.marginBottom='8px'; title.style.fontSize='0.75rem'; title.style.textTransform='uppercase'; title.style.fontWeight='700'; title.textContent='Timeline'; histCard.appendChild(title);
        const timeline = document.createElement('div'); timeline.className='timeline';
        resp.history.forEach(h=>{
          const det = document.createElement('details');
          det.innerHTML = `<summary><div style="display:flex;justify-content:space-between;gap:12px"><div><strong>${h.Status||'-'}</strong> â€” ${h.Location||'-'}</div><div class="small">${formatDate(h.Timestamp||h.time)}</div></div></summary><div class="history-detail">${h.Notes||''}</div><div class="history-meta">By: ${h.UpdatedBy||h.by||'-'}</div>`;
          timeline.appendChild(det);
        });
        histCard.appendChild(timeline);
        document.getElementById('result').appendChild(histCard);
      }

      // chat context
      if(orderKey){ const chat = loadChat(orderKey); if(chat && chat.length){ renderChat(orderKey); } }
    }

    // Cancel modal UI (single implementation)
    function openCancelModal(order, currentStatus){
      const root=document.getElementById('modalRoot');
      const alreadyCancelled = !!loadCancelFlag(order) || (currentStatus && currentStatus.toLowerCase().includes('cancel'));
      if(alreadyCancelled){
        root.innerHTML = `<div class="modal-backdrop" role="dialog" aria-modal="true"><div class="modal"><h3>Cancel order</h3><div class="small">Order: <strong>${order||'-'}</strong></div><div style="margin-top:12px" class="small">This order is already cancelled.</div><div class="actions" style="margin-top:14px"><button class="muted-btn" onclick="closeModal()">Close</button></div></div></div>`;
        root.style.display='block';
        return;
      }
      root.innerHTML = `<div class="modal-backdrop" role="dialog" aria-modal="true"><div class="modal"><h3>Cancel order</h3><div class="small">Order: <strong>${order||'-'}</strong></div><div style="margin-top:12px"><label class="small">Reason (optional)</label><textarea id="cancelReason" style="width:100%;min-height:86px;padding:10px;border-radius:8px;border:1px solid var(--border);margin-top:6px" placeholder="Tell us why you want to cancel (optional)"></textarea></div><div class="actions"><button class="track-btn cancel-btn" id="confirmCancelBtn">Confirm cancel</button><button class="muted-btn" onclick="closeModal()">Keep order</button></div></div></div>`;
      root.style.display='block';
      const btn = document.getElementById('confirmCancelBtn');
      if(btn) btn.addEventListener('click', ()=> submitCancelRequest(order));
    }

    function closeModal(){ const root=document.getElementById('modalRoot'); root.innerHTML=''; root.style.display='none'; }

    // submit cancellation to server
    async function submitCancelRequest(order) {
  const reasonEl = document.getElementById('cancelReason');
  const reason = reasonEl ? reasonEl.value.trim() : '';
  const accessCode = (document.getElementById('codeInput') && document.getElementById('codeInput').value.trim()) || '';

  if (!order) { alert('Order missing'); return; }

  const btn = document.getElementById('confirmCancelBtn');
  if (btn) { btn.disabled = true; btn.textContent = 'Cancellingâ€¦'; }

  try {
    // Use form-encoded body to avoid preflight OPTIONS
    const payload = new URLSearchParams();
    payload.append('action', 'cancel');
    payload.append('orderNumber', order);
    payload.append('accessCode', accessCode);
    payload.append('reason', reason);
    payload.append('updatedBy', 'Customer');

    const res = await fetch(API_URL, {
      method: 'POST',
      mode: 'cors',
      cache: 'no-store',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: payload.toString(),
      credentials: 'omit'
    });

    if (btn) { btn.disabled = false; btn.textContent = 'Confirm cancel'; }

    if (!res.ok) {
      const txt = await res.text().catch(()=>null);
      const msg = txt || `HTTP ${res.status}`;
      alert('Cancel failed: ' + msg);
      return;
    }

    const json = await res.json().catch(()=>null);
    if (!json) { alert('No response from server'); return; }
    if (json.error) {
      alert('Cancel failed: ' + json.error);
      return;
    }

    // success
    closeModal();
    showMessage('Order cancelled successfully. Refreshing view...','success');

    // optimistic local update + refresh
    const now = new Date().toISOString();
    saveCancelFlag(order, { cancelledAt: now, reason: reason });
    try {
      if (document.getElementById('orderInput').value.trim() && document.getElementById('codeInput').value.trim()) {
        setTimeout(()=> { search(); }, 600);
      }
    } catch(e){}

  } catch (err) {
    if (btn) { btn.disabled = false; btn.textContent = 'Confirm cancel'; }
    alert('Cancel request failed: ' + (err && err.message ? err.message : String(err)));
  }
}


      const btn = document.getElementById('confirmCancelBtn');
      if (btn) { btn.disabled = true; btn.textContent = 'Cancellingâ€¦'; }

      try {
        const payload = {
          action: 'cancel',
          orderNumber: order,
          accessCode: accessCode,
          reason: reason,
          updatedBy: 'Customer'
        };

        const res = await fetch(API_URL, {
          method: 'POST',
          mode: 'cors',
          cache: 'no-store',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          credentials: 'omit'
        });

        // re-enable button
        if (btn) { btn.disabled = false; btn.textContent = 'Confirm cancel'; }

        if (!res.ok) {
          const txt = await res.text().catch(()=>null);
          const msg = txt || `HTTP ${res.status}`;
          alert('Cancel failed: ' + msg);
          return;
        }

        const json = await res.json().catch(()=>null);
        if (!json) { alert('No response from server'); return; }
        if (json.error) {
          alert('Cancel failed: ' + json.error);
          return;
        }

        // success
        closeModal();
        showMessage('Order cancelled successfully. Refreshing view...','success');

        // save local cancelled flag and update optimistic UI
        const now = new Date().toISOString();
        saveCancelFlag(order, { cancelledAt: now, reason: reason });
        // refresh the client UI â€” attempt to re-run search() if inputs present
        try {
          if (document.getElementById('orderInput').value.trim() && document.getElementById('codeInput').value.trim()) {
            setTimeout(()=> { search(); }, 600);
          }
        } catch(e){
          // ignore
        }

      } catch (err) {
        if (btn) { btn.disabled = false; btn.textContent = 'Confirm cancel'; }
        alert('Cancel request failed: ' + (err && err.message ? err.message : String(err)));
      }
    }

    // Return stubs (so clicking "Start return" won't throw) â€” replace with real flow if/when available
    function openReturnModal(order){
      const root=document.getElementById('modalRoot');
      root.innerHTML = `<div class="modal-backdrop" role="dialog" aria-modal="true"><div class="modal"><h3>Start Return / Replacement</h3><div class="small">Order: <strong>${order||'-'}</strong></div><div style="margin-top:12px" class="small">Return flow is not enabled in this build. Please contact support to proceed.</div><div class="actions" style="margin-top:14px"><button class="muted-btn" onclick="closeModal()">Close</button></div></div></div>`;
      root.style.display='block';
    }
    function submitReturnRequest(){ alert('Return flow not implemented.'); }

    // Chat functions
    function toggleChat(){ const panel=document.getElementById('chatPanel'); if(panel.style.display==='none' || !panel.style.display){ openChat(); } else closeChat(); }
    function openChat(){ const panel=document.getElementById('chatPanel'); panel.style.display='flex'; document.getElementById('chatInput').focus(); renderChat((document.getElementById('orderInput').value.trim())||''); }
    function closeChat(){ document.getElementById('chatPanel').style.display='none'; }

    function renderChat(order){ const container=document.getElementById('chatMessages'); const orderKey = order || (document.getElementById('orderInput').value.trim()); const chat = orderKey? loadChat(orderKey) : []; container.innerHTML=''; if(!chat.length){ container.innerHTML = '<div class="chat-placeholder">No messages yet. Ask about your order or general queries.</div>'; return; } chat.forEach(m=>{ const el = document.createElement('div'); el.className='msg '+(m.from==='user'?'user':'bot'); el.innerHTML = `<div style="font-size:0.8rem;opacity:0.9;margin-bottom:4px">${m.from==='user'?'You':'Support'}</div><div>${m.text}</div><div class="small" style="opacity:0.6;margin-top:6px">${formatDate(m.ts)}</div>`; container.appendChild(el); }); container.scrollTop = container.scrollHeight; }

    function sendChat(){ const input=document.getElementById('chatInput'); const text=input.value.trim(); if(!text) return; const orderKey = (document.getElementById('orderInput').value.trim())||''; const msg = { from:'user', text, ts: new Date().toISOString() }; const key = orderKey || 'guest'; const chat = loadChat(key); chat.push(msg); saveChat(key, chat); renderChat(key); input.value=''; setTimeout(()=>{ const bot = { from:'bot', text: cannedReply(text, orderKey), ts: new Date().toISOString() }; const nowChat = loadChat(key); nowChat.push(bot); saveChat(key, nowChat); renderChat(key); }, 700); }

    function cannedReply(userText, order){ const t = userText.toLowerCase(); if(t.includes('return')||t.includes('refund')||t.includes('replace')){ if(order) return `I can help with a return or replacement for order ${order}. Click "Start return / replacement" in the order summary to begin, or tell me the reason.`; return 'I can help start a return. Please provide your order number.'; } if(t.includes('where')||t.includes('status')||t.includes('deliver')){ if(order) return `I see order ${order}. If you tracked it already, the live timeline shows the latest updates. Would you like me to refresh it?`; return 'Please provide your order number and code and I will fetch the latest status.'; } return `Thanks â€” our support team will review this. For order-specific actions, include the order number (e.g. ${order||'12345'}) and we'll assist you faster.`; }

    function saveLastResponse(order, data){ try{ sessionStorage.setItem('last_response_'+order, JSON.stringify(data)); }catch{} }

    // Initialization
    window.addEventListener('DOMContentLoaded',()=>{
      setFloatingLabels();

      const params = new URLSearchParams(window.location.search);
      const orderParam = params.get('order')||'';
      const codeParam = params.get('code')||'';
      const session = loadSession();

      if(orderParam) document.getElementById('orderInput').value = orderParam;
      else if(session.order) document.getElementById('orderInput').value = session.order;
      if(codeParam) document.getElementById('codeInput').value = codeParam;
      else if(session.code) document.getElementById('codeInput').value = session.code;

      document.querySelectorAll('.field-wrapper').forEach(w=>{ const input=w.querySelector('.floating-input'); if(input) input.dispatchEvent(new Event('input')); });

      // Track button wiring
      document.getElementById('trackBtn').addEventListener('click', search);

      if(document.getElementById('orderInput').value.trim() && document.getElementById('codeInput').value.trim()) search();

      ['orderInput','codeInput'].forEach(id=>{ const el=document.getElementById(id); el.addEventListener('keyup', e=>{ if(e.key==='Enter') search(); }); });

      // chat shortcuts
      document.getElementById('chatInput').addEventListener('keyup', e=>{ if(e.key==='Enter') sendChat(); });

      // re-adjust progress fills on resize
      window.addEventListener('resize', ()=>{ document.querySelectorAll('.card').forEach(c=>{ const pf = c.querySelector('.progress'); if(pf){ const idx = Number(pf.getAttribute('aria-valuenow'))||0; requestAnimationFrame(()=>adjustProgressFill(c, idx)); } }); });
    });

    // Expose some globals used inline in HTML
    window.openReturnModal = openReturnModal;
    window.closeModal = closeModal;
    window.submitReturnRequest = submitReturnRequest;
    window.openChat = openChat;
    window.toggleChat = toggleChat;
    window.sendChat = sendChat;
    window.openCancelModal = openCancelModal;
    window.submitCancelRequest = submitCancelRequest;
  </script>
</body>
</html>
